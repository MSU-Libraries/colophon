
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.17">
    
    
      
        <title>Colophon</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.26e3688c.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#colophon-file-quality-control-validator" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="Colophon" class="md-header__button md-logo" aria-label="Colophon" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Colophon
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Colophon: File Quality Control Validator
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/msu-libraries/colophon" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    msu-libraries/colophon
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Colophon" class="md-nav__button md-logo" aria-label="Colophon" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Colophon
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/msu-libraries/colophon" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    msu-libraries/colophon
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="#installing" class="md-nav__link">
        Installing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="#how-colophon-works" class="md-nav__link">
        How Colophon Works
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="#running-colophon" class="md-nav__link">
        Running Colophon
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="#the-manifest-file" class="md-nav__link">
        The Manifest File
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="#the-suite-file" class="md-nav__link">
        The Suite File
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="#check-scripts" class="md-nav__link">
        Check Scripts
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="#author-and-copyright" class="md-nav__link">
        Copyright and License
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="colophon-file-quality-control-validator">Colophon: File Quality Control Validator</h1>
<p>Colophon is a tool to take a media object manifest, find related
files using a flexible matching system, and then run any
number of scripts to validate the files founds. The output is
then bundled into a zip file, including HTML report summary,
JSON data details, and full output of all scripts run.</p>
<p><strong>Table of Contents</strong>  </p>
<ul>
<li><a href="#installing">Installing</a></li>
<li><a href="#how-colophon-works">How Colophon Works</a></li>
<li><a href="#running-colophon">Running Colophon</a></li>
<li><a href="#the-manifest-file">The Manifest File</a></li>
<li><a href="#the-suite-file">The Suite File</a></li>
<li><a href="#check-scripts">Check Scripts</a></li>
<li><a href="#author-and-copyright">Copyright and License</a></li>
</ul>
<h2 id="installing">Installing</h2>
<p>Colophon is written primarily in Python, but makes use of scripts
to run validation tests. These scripts can be written in any language,
and you can add your own quite easily!</p>
<p>Create your virutal environment
<div class="highlight"><pre><span></span><code><span class="c1"># Using virtualenv here, but you can use whatever you want</span>
virtualenv<span class="w"> </span>-p<span class="w"> </span>python3<span class="w"> </span>env
</code></pre></div></p>
<p>Install Python dependences
<div class="highlight"><pre><span></span><code><span class="c1"># Activate your virtual environment</span>
.<span class="w"> </span>env/bin/activate
<span class="c1"># Install dependencies defined in the requirements.txt file</span>
pip3<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt
</code></pre></div></p>
<p>Running colophon
<div class="highlight"><pre><span></span><code><span class="c1"># If you&#39;ve activated your environment</span>
./colophon<span class="w"> </span>-h
<span class="c1"># Or call via env directly</span>
./env/bin/python3<span class="w"> </span>colophon<span class="w"> </span>-h
</code></pre></div></p>
<h3 id="script-dependencies">Script Dependencies</h3>
<p>Depending on which scripts you use, some of all of the following
dependendies will be needed. Here are the commands to install
them on Ubuntu, but you should be able to easily find these
packages on most Linux distributions.</p>
<p>Install dependencies on Ubuntu (<code>bash</code> already present)
<div class="highlight"><pre><span></span><code>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>jq<span class="w"> </span>imagemagick<span class="w"> </span>mediainfo
</code></pre></div></p>
<h2 id="what-is-needed-to-run">What is Needed to Run</h2>
<p>Before you can run Colophon, you will need the following:</p>
<ul>
<li>A folder with data to be checked (the files <strong>source directory</strong>)</li>
<li>A CSV listing records that need to be verified (the <strong>manifest</strong>)</li>
<li>A configuration file of what tests to run (the <strong>suite</strong> of tests)</li>
</ul>
<h3 id="other-terms-to-know">Other Terms to Know</h3>
<ul>
<li><strong>Error</strong>: A script was unable to complete. This is likely due to due incorrect input or missing dependencies.</li>
<li><strong>Failure</strong>: A script ran to completion, but the validation did not succeed on the given file using the given parameters.</li>
</ul>
<h2 id="how-colophon-works">How Colophon Works</h2>
<p>Colophon starts with the manifest file. This is an arbitrary CSV file
with a header row to give column labels.</p>
<div class="highlight"><pre><span></span><code>&quot;mediatype&quot;,&quot;basename&quot;, &quot;title&quot;
&quot;Video&quot;,    &quot;UP-F00001&quot;,&quot;UPP302 - Press presentation 02/10/2004&quot;
&quot;Video&quot;,    &quot;UP-F00002&quot;,&quot;UPP710 - President&#39;s speech 12/20/2007&quot;
&quot;Book&quot;,     &quot;UP-F00003&quot;,&quot;UPP098 - College pamphlet 1921&quot;
</code></pre></div>
<p>When running Colphon, you will also specify a directory where files
related to the manifest should be found.</p>
<div class="highlight"><pre><span></span><code>batch_01/upp302/UP-F00001.mkv
batch_01/upp302/UP-F00001.mkv.md5
batch_01/upp302/UP-F00001.mp4
batch_01/upp302/UP-F00001.mp4.md5
batch_01/upp302/UP-F00001_asset_cover.tif
batch_01/upp302/UP-F00001_asset_back.tif
batch_01/upp710/UP-F00002.mkv
batch_01/upp302/UP-F00002.mkv.md5
batch_01/upp710/UP-F00002.mp4
batch_01/upp302/UP-F00002_digitization_notes.txt
batch_01/upp098/UP-F00003.pdf
batch_01/upp098/UP-F00003_front.tif
batch_01/upp098/UP-F00003_back.tif
batch_01/upp098/UP-F00003_front.jpg
batch_01/upp098/UP-F00003_back.jpg
</code></pre></div>
<p>And finally, a test suite file while specifies what Colophon should
do.</p>
<p>Example of the first part of a test suite file. The <code>manifest:</code> section:
<div class="highlight"><pre><span></span><code><span class="nt">manifest</span><span class="p">:</span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">basename</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w">  </span><span class="c1"># id should be unique data; it&#39;s used in logs and output</span>
<span class="w">  </span><span class="nt">filter</span><span class="p">:</span><span class="w">               </span><span class="c1"># only use manifest rows that match these filters</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mediatype</span>
<span class="w">      </span><span class="nt">equals</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Video</span>
<span class="w">  </span><span class="nt">files</span><span class="p">:</span><span class="w">                </span><span class="c1"># find files matching the manifest row</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">preserve_copy</span>
<span class="w">      </span><span class="nt">startswith</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">basename</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">      </span><span class="nt">endswith</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;.mkv&#39;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">access_copy</span>
<span class="w">      </span><span class="nt">startswith</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">basename</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">      </span><span class="nt">endswith</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;.mp4&#39;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">preserve_hash</span>
<span class="w">      </span><span class="nt">startswith</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">basename</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">      </span><span class="nt">endswith</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;.mkv.md5&#39;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">access_hash</span>
<span class="w">      </span><span class="nt">startswith</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">basename</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">      </span><span class="nt">endswith</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;.mp4.md5&#39;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">asset_file</span>
<span class="w">      </span><span class="nt">multiple</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">optional</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">startswith</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">basename</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">      </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;_asset.*\.tif$&#39;</span>
</code></pre></div></p>
<p>Colophon will iterate over the rows in the manifest, comparing it to
the suite and source directory. If manifest row matches the given
suite files, Colophon will attempt to find matching <em>files</em> from the
source directory based of definitions within the suite file.</p>
<p>Example of the second part of a test suite file. The <code>stages:</code> section:
<div class="highlight"><pre><span></span><code><span class="nt">stages</span><span class="p">:</span><span class="w">                 </span><span class="c1"># run a set of stages (scripts) for each manifest row</span>
<span class="w">  </span><span class="nt">access.hash</span><span class="p">:</span><span class="w">          </span><span class="c1"># each stage name is just a label for identifing the stage</span>
<span class="w">    </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;scripts/verify-hash</span><span class="nv"> </span><span class="s">-c</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">access_copy</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-f</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">access_hash</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-v</span><span class="nv"> </span><span class="s">-J</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">results_path</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">  </span><span class="nt">preserve.hash</span><span class="p">:</span>
<span class="w">    </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;scripts/verify-hash</span><span class="nv"> </span><span class="s">-c</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">preserve_copy</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-f</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">preserve_hash</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-v</span><span class="nv"> </span><span class="s">-J</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">results_path</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">  </span><span class="nt">access.audio</span><span class="p">:</span>
<span class="w">    </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;scripts/validate-audio</span><span class="nv"> </span><span class="s">-c</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">access_copy</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-s</span><span class="nv"> </span><span class="s">48000</span><span class="nv"> </span><span class="s">-m</span><span class="nv"> </span><span class="s">CBR</span><span class="nv"> </span><span class="s">-v</span><span class="nv"> </span><span class="s">-J</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">results_path</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">  </span><span class="nt">preserve.audio</span><span class="p">:</span>
<span class="w">    </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;scripts/validate-audio</span><span class="nv"> </span><span class="s">-c</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">prezerve_copy</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-s</span><span class="nv"> </span><span class="s">48000</span><span class="nv"> </span><span class="s">-m</span><span class="nv"> </span><span class="s">CBR</span><span class="nv"> </span><span class="s">-b</span><span class="nv"> </span><span class="s">24</span><span class="nv"> </span><span class="s">-v</span><span class="nv"> </span><span class="s">-J</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">results_path</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">  </span><span class="nt">access.video</span><span class="p">:</span>
<span class="w">    </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;scripts/validate-video</span><span class="nv"> </span><span class="s">-c</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">access_copy</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-d</span><span class="nv"> </span><span class="s">640x480</span><span class="nv"> </span><span class="s">-b</span><span class="nv"> </span><span class="s">8</span><span class="nv"> </span><span class="s">-v</span><span class="nv"> </span><span class="s">-J</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">results_path</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">  </span><span class="nt">preserve.video</span><span class="p">:</span>
<span class="w">    </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;scripts/validate-video</span><span class="nv"> </span><span class="s">-c</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">preserve_copy</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-d</span><span class="nv"> </span><span class="s">720x486</span><span class="nv"> </span><span class="s">-b</span><span class="nv"> </span><span class="s">10</span><span class="nv"> </span><span class="s">-v</span><span class="nv"> </span><span class="s">-J</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">results_path</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div></p>
<p>With files in hand, Colophon then runs stages of user-defined scripts
(also defined in the suite file). If those scripts succeed, then we
move onto the next stage. Once all stages are completed for a manifest
row, the process repeats for the next row until all rows are completed.</p>
<p>Finally, all results, reports, and script output are bundled together
and returned as a zip file.</p>
<p>Example section of the <code>summary.json</code> file, which is included in the output:
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;row-overview&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;succeeded&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;failed&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;skipped&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;skipped&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;UP-F00003&quot;</span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;failed&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;UP-F00002&quot;</span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;unassociated-files&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;batch_01/upp302/UP-F00002_digitization_notes.txt&quot;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;rows&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;UP-F00001&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;exit-codes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;0&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;occurrences&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;code-meaning&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;success&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;UP-F00002&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;failures&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;Manifest(id=UP-F00002) was required to match a file for label &#39;access_hash&#39;, but no matching file was found.&quot;</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;UP-F00003&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;skipped-because&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Filter did not match: {&#39;value&#39;: &#39;mediatype&#39;, &#39;equals&#39;: &#39;video&#39;}&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>Much of Colophon process is user defined, which makes it very flexible
and configurable. It does mean you will need to invest some time into
creating a the suite file before running your verifications.</p>
<h2 id="running-colophon">Running Colophon</h2>
<p>Assuming you have the three required components ready (source directory,
manifest file, suite file), then running <code>colophon</code> is quite simple.
<div class="highlight"><pre><span></span><code>./colophon<span class="w"> </span>-m<span class="w"> </span>example_manifest.csv<span class="w"> </span>-s<span class="w"> </span>suites/verify-video.yml<span class="w"> </span>-d<span class="w"> </span>example_files/<span class="w"> </span>-v
</code></pre></div></p>
<p>Where the arguments are:</p>
<ul>
<li><code>example_manifest.csv</code> is the CSV file containing the manifest</li>
<li><code>suites/verify-video.yml</code> is a YAML file defining the suite to run against the manifest</li>
<li><code>example_files/</code> is a directory where files associated with the manifest are located</li>
</ul>
<h3 id="flags-and-arguments">Flags and Arguments</h3>
<p>A full list of command options is also avilable by using the <code>-h</code> or <code>--help</code> flag.</p>
<ul>
<li><code>-m, --manifest MNFST</code>    The file manifest as csv file; first row defines labels for each column  [required]</li>
<li><code>-s, --suite SUITE</code>       The suite file defining files to match and what stages to run  [required]</li>
<li><code>-d, --dir DIR</code>           The source directory in which to find files defined by the suite and manifest  [required]</li>
<li><code>-w, --workdir WORKDIR</code>   A directory where to store temp files and results</li>
<li><code>-r, --retry FAILED</code>      Re-run failed tests specified in provided JSON file from previous run</li>
<li><code>-i, --ignore-missing</code>    Ignore manifest entries that have no files matched</li>
<li><code>-t, --strict</code>            Exit code 0 only with no manifest entries skipped and no unassociated files</li>
<li><code>-v, --verbose</code>           Provide details output while running (verbose logs will always be inlcuded in output bundle)</li>
<li><code>-q, --quiet</code>             Suppress output while running</li>
</ul>
<h3 id="colophon-exit-codes">Colophon Exit Codes</h3>
<p>The primary <code>colophon</code> script has three possible exit codes.</p>
<ul>
<li><code>0</code> There were no failures when running stages on manifest entries.</li>
<li><code>1</code> An error occured. See output/logs for detals.</li>
<li><code>2</code> While running stages, one or more failures occurred.</li>
<li><code>2</code> (When using strict mode) A manifest entry was skipped or there were unassociated files.</li>
</ul>
<h3 id="colophon-output">Colophon Output</h3>
<p>If <code>colophon</code> exits without an error (exit code <code>0</code> or <code>2</code>), the only output to
<strong>stdout</strong> will be the full path of of the results zip file. Any other output during
a normal run will be to <strong>stderr</strong>.</p>
<p>Should <code>colophon</code> exit with an error, no results zip file will be generated. All
error messages will be send to <strong>stderr</strong>. You can also inspect files in the
<strong>workdir</strong> for additional information. The workdir is where files are placed before
getting added to the zip archive. The workdir is either manually specified with
the <code>--workdir</code> flag or created automatically in a temp directory (e.g. in <code>/tmp/</code>).</p>
<p>Details on what is contained within an output file are listed below.</p>
<p><strong><code>summary.json</code></strong><br />
A JSON file containing all manifest objects, including number of
successful stages for each, failures and a short description for the failure reason,
and explainations of why an manifest row was skipped. Additionally, if any files
from the source directory did not matched any rows, they are listed as
<code>unassociated-files</code> in the summary.</p>
<p><strong><code>results.json</code></strong><br />
A JSON files where scripts invoked by the stages can store additional
output.</p>
<p><strong><code>manifest.csv</code></strong><br />
The processed manifest file, including any additional columns created
from suite file matches.</p>
<p><strong><code>colophon.log</code></strong><br />
The verbose logs from the main <code>colophon</code> program.</p>
<p><strong><code>{ID}/{STAGE}/stdout.txt</code></strong><br />
For each stage/manifest row, the a file recording the
stdout generated by script script.</p>
<p><strong><code>{ID}/{STAGE}/stderr.txt</code></strong><br />
For each stage/manifest row, the a file recording the
stderr generated by script script.</p>
<p><strong><code>{ID}/{STAGE}/ecode.{EXITCODE}</code></strong><br />
For each stage/manifest row, the a file identifying
the exit code from the script run. Human readable tags
describing the exit code are within the file.</p>
<h2 id="the-manifest-file">The Manifest File</h2>
<p>The manifest is a CSV file with fields relevant to performing the quality control
checks desired. The can include:</p>
<ul>
<li>Sufficient naming to identify files</li>
<li>Some identifying data, in the case where the name info doesn't do this</li>
<li>The type of object or media, if multiple types are present</li>
<li>Additional fields specifying validation parameters where they could vary from record to record</li>
<li>E.g. Video resolution, color bit depth, compression type</li>
</ul>
<p>An example manifest could look like this:
<div class="highlight"><pre><span></span><code>&quot;mediatype&quot;,&quot;basename&quot;,&quot;name&quot;, &quot;resolution&quot;, &quot;DPI&quot;
&quot;audio&quot;,&quot;MSUF000000&quot;,&quot;Adams interview&quot;, &quot;&quot;, &quot;&quot;
&quot;Video&quot;,&quot;MSUF000001&quot;,&quot;Billing&#39;s debate&quot;, &quot;720x480&quot;, &quot;&quot;
&quot;book&quot;,&quot;MSUF000002&quot;,&quot;Chloe&#39;s Biography&quot;, &quot;&quot;, &quot;400&quot;
&quot;Audio&quot;,&quot;MSUF000003&quot;,&quot;Declan&#39;s speech&quot;, &quot;&quot;, &quot;&quot;
&quot;Video&quot;,&quot;MSUF000005&quot;,&quot;Eric&#39;s review&quot;, &quot;640x480&quot;, &quot;&quot;
&quot;Book&quot;,&quot;MSUF000006&quot;,&quot;Ferrell&#39;s history &quot;, &quot;&quot;, &quot;300&quot;
</code></pre></div></p>
<p>If an attribute of a file is going to be consistent across all items
being verified, they do <em>not</em> need to be in the manifest. We can
put those values into the testing suite directly. </p>
<h3 id="generating-a-manifest">Generating a Manifest</h3>
<p>If you have a spreadsheet, such as a <code>.xlsx</code> or <code>.ods</code> with the needed fields,
Colophon comes with a helper script to convert it to <code>.csv</code>. It may
be easier to create a new <code>.csv</code> using your preferred spreadsheet program, this
script may help if you are trying to create a programmatic solutions.</p>
<p>It takes a mapping of old column IDs (e.g. <code>a</code>, <code>b</code>, etc) to new column names,
as well as number of header rows to ignore.</p>
<p>Example manifest map <code>.yml</code> file:
<div class="highlight"><pre><span></span><code><span class="nn">---</span>
<span class="nt">skiprows</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nt">columns</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">b</span>
<span class="w">    </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mediatype</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">c</span>
<span class="w">    </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">basename</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">f</span>
<span class="w">    </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">j</span>
<span class="w">    </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">resolution</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">column</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">n</span>
<span class="w">    </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dpi</span>
</code></pre></div></p>
<p>Generating the manifest:
<div class="highlight"><pre><span></span><code>./helpers/generate-manifest-from-spreadsheet<span class="w"> </span>-s<span class="w"> </span>my-speadsheet.xlsx<span class="w"> </span>-m<span class="w"> </span>my-mapfile.yml<span class="w"> </span>-o<span class="w"> </span>my-new-manifest.csv
</code></pre></div></p>
<h2 id="the-suite-file">The Suite File</h2>
<p>The suite file is written in Yaml and defines everything Colophon does when you run it.
Example suite files are provided in the <code>suites/</code> directory with Colophon. You will
need to heavily modify these to suite your own media if you decide to start with one of these.</p>
<p>Basic structure of a suite files is as follows:
<div class="highlight"><pre><span></span><code><span class="nn">---</span>
<span class="c1"># The manifest: section defines how Colophon will read/update the manifest.</span>
<span class="c1"># It operates on a row-by-row basis within the manifest. E.g. each row in the</span>
<span class="c1"># manifest will be checked against the filter: and each row will search to</span>
<span class="c1"># find matching files: from the source directory.</span>
<span class="nt">manifest</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># The id: allows you to define how a manifest row is referred to by Colophon</span>
<span class="w">  </span><span class="c1"># A string value that should be unique (otherwise it would serve as a poor identifier!)</span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w">       </span><span class="c1"># (string)</span>
<span class="w">  </span><span class="c1"># The filter: allows you to selectively iterate over only manifest rows which</span>
<span class="w">  </span><span class="c1"># match all the filters you define here.</span>
<span class="w">  </span><span class="nt">filter</span><span class="p">:</span><span class="w">   </span><span class="c1"># (list)</span>
<span class="w">  </span><span class="c1"># The files: has you define rules for finding each of the files from the source</span>
<span class="w">  </span><span class="c1"># directory which will be associated with the manifest row. Each file has</span>
<span class="w">  </span><span class="c1"># a label you define and that label will be added to the manifest with the</span>
<span class="w">  </span><span class="c1"># associated value being the matched file(s).</span>
<span class="w">  </span><span class="nt">files</span><span class="p">:</span><span class="w">    </span><span class="c1"># (list)</span>

<span class="c1"># The stages: section defines a set of independent stages, each with a command</span>
<span class="c1"># that will be run using the manifest row data. This happens only AFTER the</span>
<span class="c1"># above manifest: section has completed filtering and finding files.</span>
<span class="nt">stages</span><span class="p">:</span><span class="w">     </span><span class="c1"># (associative array)</span>
</code></pre></div></p>
<p>A full definition of manifest fields, templating values into them, and their
sub-fields are covered in the next documentation sections.</p>
<h3 id="template-strings">Template Strings</h3>
<p>Colophon makes use of <a href="https://jinja2docs.readthedocs.io/">Jinja2</a> template rendering
when parsing values from suite files (except for <code>regex</code> expressons).</p>
<p>Any fields within the manifest can be referenced inside the suite by means of Jinja expressions,
such as <code>{{ field_name }}</code>. Depending on the context, additional variables may be available within
the template render context.</p>
<p>For example, if the manifest had a column header called <code>objectname</code>, then you would
be able to reference <code>{{ objectname }}</code> within a string to insert the row value for
that column.</p>
<p>In addition to <a href="https://jinja.palletsprojects.com/en/3.0.x/templates/#builtin-filters">built-in Jina2 filters</a>,
Colophon provides the additional filters:</p>
<ul>
<li><code>basename</code> Runs Python's <code>os.path.basename()</code> on the value.</li>
<li><code>esh</code> Escapes the value for use as a shell command argument. This is applied automatically within <code>stages:</code> section of suites.</li>
</ul>
<p><strong><code>manifest.files:</code></strong><br />
Within the <code>files:</code> section, the following variables are available in addition to
the normal <code>manifest</code> fields:</p>
<ul>
<li><code>file.name</code>: The full name of the file (no path)</li>
<li><code>file.path</code>: The full path of the file</li>
<li><code>file.base</code>: The name of the file without its extension</li>
<li><code>file.ext</code>: The file extension (no leading period)</li>
<li><code>file.size</code>: The size of the file in bytes</li>
</ul>
<p><strong><code>stages</code></strong><br />
Within the <code>stages:</code> section, any files defined within the <code>manifest.files:</code> section have
already been added to the manifest. The <code>label:</code> becomes the manifest field name, and the
matched file becomes the value (or blank if not match and the file was optional).</p>
<p>With stages, the variable <code>results_path</code> is also available. This is the path to the
<code>results.json</code> which will be included in the output zip bundle. This is indended to be
used with scripts' <code>-J</code> flag, which may <a href="#results-json-file-as-input-argument">output JSON results</a>.</p>
<p><em>Note</em>: Jinja variables within the <code>stages</code> section of the manifest will be automatically
quoted for use as arguments within a shell environment.</p>
<h3 id="manifest-field-details">Manifest Field Details</h3>
<h4 id="manifestid-string"><code>manifest.id:</code> (string)</h4>
<p>The <code>id:</code> field in the manifest is used within logs to identify which row the log entry
is referring to. It is strongly recommended you define this to be a unique value from
within your manifest.</p>
<div class="highlight"><pre><span></span><code><span class="nt">manifest</span><span class="p">:</span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">mediatype</span><span class="nv"> </span><span class="s">}}-{{</span><span class="nv"> </span><span class="s">objectid</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div>
<h4 id="manifestfilters-list"><code>manifest.filters:</code> (list)</h4>
<p>Allows the suite to filter specific rows to process. Only rows matching all
provided filters will be used. Rows which do not match the filters will be
ignored.</p>
<p>Each filter is an associative array and takes a <code>value:</code>, which must be a
manifest field name. Additionally, it needs one or more types of filters.</p>
<p>The <strong>filter types</strong> are:</p>
<ul>
<li><code>equals:</code> The field in <code>value:</code> must be exactly the value of this.</li>
<li><code>startswith:</code> The field in <code>value:</code> must start with the value of this.</li>
<li><code>endswith:</code> The field in <code>value:</code> must end with the value of this.</li>
<li><code>regex:</code> The field in <code>value:</code> must match this regular expression. (Note that <code>regex:</code> values do NOT render as Jinja2 templates.)</li>
<li><code>ignorecase:</code> Boolean. If set to <code>true</code>, the other filter types within this filter are case insensitive. (Note that this <em>does</em> affect <code>regex:</code>.)</li>
<li><code>greaterthan:</code> The field in <code>value:</code> must be numerically greater than this.</li>
<li><code>lessthan:</code> The field in <code>value:</code> must be numerically less than this.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">manifest</span><span class="p">:</span>
<span class="w">  </span><span class="nt">filters</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mediatype</span>
<span class="w">    </span><span class="nt">equals</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audio</span>
<span class="w">    </span><span class="nt">ignorecase</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">donor</span>
<span class="w">    </span><span class="nt">endswith</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Smith</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">year</span>
<span class="w">    </span><span class="nt">greaterthan</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1950</span>
<span class="w">    </span><span class="nt">lessthan</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1961</span>
</code></pre></div>
<h4 id="manifestfiles-list"><code>manifest.files:</code> (list)</h4>
<p>Define which files should be found for each row in the manifest. Each
item in the <code>files:</code> section <em>requires</em> a <code>label:</code> defined. The <code>label:</code>
will be a new field within the manifest for which the value will be the
path of the matched file(s).</p>
<p>Each entry in <code>files:</code> also makes use of the same <strong>filter types</strong>
defined in the <code>manifest.filters:</code> section above.</p>
<p>Additionally, the following fields are available:</p>
<ul>
<li><code>multiple:</code> Boolean. If set to <code>true</code>, this file entry can match any number of files.</li>
<li><code>optional:</code> Boolean. If set to <code>true</code>, this file entry is optional and will not cause a failure should no matching files be found.</li>
<li><code>linkedto:</code> Defines a linked file. Must be given <code>label:</code> to another file that has already been defined. This requires a file match for each file match the linked file entry finds, even if that linked file entry was optional.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">manifest</span><span class="p">:</span>
<span class="w">  </span><span class="nt">files</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metadata_file</span>
<span class="w">    </span><span class="nt">startswith</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">objectname</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">    </span><span class="nt">endswith</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;_mods.xml&#39;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pres_file</span>
<span class="w">    </span><span class="nt">startswith</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">objectname</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">    </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;(?:\.mov|\.mkv)$&#39;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pres_hash</span>
<span class="w">    </span><span class="nt">startswith</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">objectname</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">    </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;(?:\.mov|\.mkv).md5$&#39;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">asset</span>
<span class="w">    </span><span class="nt">multiple</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">optional</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">startswith</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">objectname</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">    </span><span class="nt">endswith</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;_asset.tif&#39;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">asset_hash</span>
<span class="w">    </span><span class="nt">linkedto</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">asset</span>
<span class="w">    </span><span class="nt">startswith</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">asset</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">basename</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">    </span><span class="nt">endswith</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;.md5&#39;</span>
</code></pre></div>
<h4 id="stages-associative-array"><code>stages:</code> (associative array)</h4>
<p>The <code>stages:</code> section contains any number of stages which will be iterated
over in order.</p>
<h4 id="stagesstage_name-associative-array"><code>stages.STAGE_NAME:</code> (associative array)</h4>
<p>Where <code>STAGE_NAME</code> is a unique value used to identify that stage. For example,
it could be <code>stage1.0</code>, <code>stage1.1</code>, <code>stage1.2</code>, etc. Or more descriptive like
<code>audio.file-metadata</code>,<code>audio.waveform</code>,<code>video-metadata</code>, etc.</p>
<p>The <code>STAGE_NAME</code> will be used within logs and in structuring the location of script
output files (e.g. <code>stdout.txt</code>).</p>
<h4 id="stagesstage_namescript-string"><code>stages.STAGE_NAME.script:</code> (string)</h4>
<p>Define the script command to run for the given stage. Jinja expressions used
within the command will be auto-escaped for use as arguments within a shell command.</p>
<p>The output of the command will always be saved in the output zip bundle within
the path <code>{{ manifest.id }}/{{ STAGE_NAME }}/</code>:</p>
<ul>
<li><code>stdout.txt</code> All output to stdout while the script ran.</li>
<li><code>stderr.txt</code> All output to stderr while the script ran.</li>
<li><code>ecode.?</code> The script exit code (where <code>?</code> is in the filename). The contents of the file will also include the exit code and human readable label(s) explaining the exit code's meaning.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="nt">video.hash</span><span class="p">:</span>
<span class="w">    </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;scripts/verify-hash</span><span class="nv"> </span><span class="s">-c</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">media_file</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-f</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">media_file_hash</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-v</span><span class="nv"> </span><span class="s">-J</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">results_path</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">  </span><span class="nt">video.size</span><span class="p">:</span>
<span class="w">    </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;custom-scripts/validate-size</span><span class="nv"> </span><span class="s">-c</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">media_file</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">--min-size</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">bytes_lower</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">--max-size</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">bytes_upper</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-v&quot;</span>
</code></pre></div>
<h2 id="check-scripts">Check Scripts</h2>
<p>Colophon works by running a set of check scripts in stages against your manifest.</p>
<p>Well written scripts will provide a full list of flags and their use by using the <code>-h</code> or
<code>--help</code> flag.
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./scripts/verify-hash<span class="w"> </span>-h

Usage:<span class="w"> </span>verify-hash<span class="w"> </span><span class="o">[</span>FLAGS<span class="o">]</span>

<span class="w">  </span>Verify<span class="w"> </span>a<span class="w"> </span>file<span class="w"> </span>contents<span class="w"> </span>matches<span class="w"> </span>a<span class="w"> </span>given<span class="w"> </span><span class="nb">hash</span>

FLAGS:
<span class="w">  </span>-c<span class="p">|</span>--check-file<span class="w"> </span>FILE
<span class="w">      </span>The<span class="w"> </span>file<span class="w"> </span>to<span class="w"> </span>verify
<span class="w">  </span>-f<span class="p">|</span>--hash-file<span class="w"> </span>HASH_FILE
<span class="w">      </span>A<span class="w"> </span>file<span class="w"> </span>containing<span class="w"> </span>a<span class="w"> </span><span class="nb">hash</span><span class="w"> </span>to<span class="w"> </span>verify<span class="w"> </span>against.
<span class="w">  </span>-s<span class="p">|</span>--hash-str<span class="w"> </span>HASH_STR
<span class="w">      </span>A<span class="w"> </span>string<span class="w"> </span><span class="nb">hash</span><span class="w"> </span>to<span class="w"> </span>verify<span class="w"> </span>against.
<span class="w">  </span>-a<span class="p">|</span>--algo<span class="w"> </span>ALGO
<span class="w">      </span>The<span class="w"> </span>algorithm<span class="w"> </span>to<span class="w"> </span>use.<span class="w"> </span>E.g.<span class="w"> </span>md5,<span class="w"> </span>sha1,<span class="w"> </span>sha256,<span class="w"> </span>etc
<span class="w">  </span>-J<span class="p">|</span>--json<span class="w"> </span>JSON
<span class="w">      </span>Write<span class="w"> </span>results<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>file<span class="w"> </span>JSON.
<span class="w">  </span>-v<span class="p">|</span>--verbose
<span class="w">      </span>Display<span class="w"> </span>verbose<span class="w"> </span>output.
</code></pre></div></p>
<h3 id="included-check-scripts">Included Check Scripts</h3>
<p>Colophon includes a number of check-scripts, though you can always <a href="#writing-a-check-script">write your own</a>. Additional scripts and script features will be included with each future Colophon release.</p>
<p>All these are included in the <code>scripts/</code> directory. A brief summary of these scripts are included below. For the most up-to-date info on these scripts, refer to their <code>--help</code> info.</p>
<h4 id="verify-hash"><code>verify-hash</code></h4>
<p>Verify a file contents matches a given hash, the hash being either in
a file or passed as string argument.</p>
<p>Example use:
<div class="highlight"><pre><span></span><code><span class="c1"># Verify MD5 hash of media-file.wav matches hash within media-file.wav.md5 (algo auto-detected)</span>
./scripts/verify-hash<span class="w"> </span>-c<span class="w"> </span>media-file.wav<span class="w"> </span>-f<span class="w"> </span>media-file.wav.md5<span class="w"> </span>-v
<span class="c1"># Verify MD5 hash of media-file.wav matches hash within media-file.wav.md5 (hash file auto-detected)</span>
./scripts/verify-hash<span class="w"> </span>-c<span class="w"> </span>media-file.wav<span class="w"> </span>-a<span class="w"> </span>md5<span class="w"> </span>-v
<span class="c1"># Verify MD5 hash of media-file.wav matched provided string hash</span>
./scripts/verify-hash<span class="w"> </span>-c<span class="w"> </span>media-file.wav<span class="w"> </span>-s<span class="w"> </span>d8e8fca2dc0f896fd7cb4cb0031ba249<span class="w"> </span>-v
</code></pre></div></p>
<h4 id="validate-image"><code>validate-image</code></h4>
<p>Validate the given image has the attributes provided. If multiple values for the same attribute
is given, the image may match any one of them.</p>
<p>Example use:
<div class="highlight"><pre><span></span><code><span class="c1"># Validate image dimension either of the provided options and that compression is disabled</span>
./scripts/validate-image<span class="w"> </span>-c<span class="w"> </span>media-file.tif<span class="w"> </span>-d<span class="w"> </span>4000x3000<span class="w"> </span>-d<span class="w"> </span>6000x3000<span class="w"> </span>-x<span class="w"> </span>none<span class="w"> </span>-v
<span class="c1"># Validate image dimension is exactly the provided one and that compression is LZW</span>
./scripts/validate-image<span class="w"> </span>-c<span class="w"> </span>media-file.tif<span class="w"> </span>-d<span class="w"> </span>1600x1200<span class="w"> </span>-x<span class="w"> </span>lzw<span class="w"> </span>-v
</code></pre></div></p>
<h4 id="validate-audio"><code>validate-audio</code></h4>
<p>Validate the given audio file, or an audio stream in a video file, has the attributes provided.
If multiple values for the same attribute is given, the media file may match any one of them.</p>
<p>Example use:
<div class="highlight"><pre><span></span><code><span class="c1"># Validate audio stream sampling rate (either 44100 or 48000), bitrate mode (CBR), and bit depth (24)</span>
./scripts/validate-audio<span class="w"> </span>-c<span class="w"> </span>media-file.wav<span class="w"> </span>-s<span class="w"> </span><span class="m">48000</span><span class="w"> </span>-s<span class="w"> </span><span class="m">44100</span><span class="w"> </span>-m<span class="w"> </span>cbr<span class="w"> </span>-b<span class="w"> </span><span class="m">24</span><span class="w"> </span>-v
</code></pre></div></p>
<h4 id="validate-video"><code>validate-video</code></h4>
<p>Validate the given video file has the attributes provided.
If multiple values for the same attribute is given, the media file may match any one of them.</p>
<p>Example use:
<div class="highlight"><pre><span></span><code><span class="c1"># Validate video stream dimensions (either 720x486 or 720x480) and color bit depth (10)</span>
./scripts/validate-video<span class="w"> </span>-c<span class="w"> </span>media-file.mkv<span class="w"> </span>-d<span class="w"> </span>720x486<span class="w"> </span>-d<span class="w"> </span>720x480<span class="w"> </span>-b<span class="w"> </span><span class="m">10</span><span class="w"> </span>-v
</code></pre></div></p>
<h3 id="writing-a-check-script">Writing a Check Script</h3>
<p>A check script can be written in any lanugage or shell which abides by a set of rules.</p>
<h4 id="relative-paths">Relative Paths</h4>
<p>Check scripts should accept relative paths as input arguments and should <em>NOT</em>
attempt to convert them into absolute paths at any point. If relative paths were
passed in, then relative paths should be used for any logs or output.</p>
<h4 id="input">Input</h4>
<p>It is recommended that a check script can accept a JSON file as an input argument.
This would be the <code>results.json</code> and the script should write the result of its
check to this file in a manner that <em>does not overwrite any other data in the file</em>
(additions only).</p>
<p>The choice for how you accept input arguments for the script is up to you, but
it is recommended to follow the same style as existing scripts. Have a look at
the <code>scripts/</code> directory for examples.</p>
<h4 id="file-modification">File Modification</h4>
<ol>
<li>A script must <strong>never</strong> modify any data or file from the source directory.</li>
<li>A script must <strong>never</strong> create any files/folders inside the source directory.</li>
</ol>
<h4 id="output">Output</h4>
<p>Output from a check script may write anything to stdout or stderr, be it output
from commands it is calling, debug messages, or informational messages.</p>
<p>A check script <em>should</em> write failures or warning information to stderr instead
of stdout. This will be logged separately in order to help assist with reviewing
and media issues found.</p>
<p>A check script <em>may</em> write structured output data into
the <a href="#results-json-file-as-input-argument">Results-JSON</a> file.</p>
<h4 id="exit-codes">Exit Codes</h4>
<p>Check scripts <strong>must</strong> have a standard exit code which indicates the result
of the script. A code of <code>0</code> means the check was successful. Any other value means
something occurred which might require attention; this includes failing the
check entirely, but may also be something like a warning notice. In call cases
where a non-<code>0</code> exit code was generated, you can refer to the script output
for details.</p>
<p><strong>Exit Codes</strong></p>
<ul>
<li><code>0</code>  indicates that the script ran successfully and no issues were found.</li>
<li><code>1</code>  indicates that the check failed for some reason. See output/logs.</li>
<li><code>3</code>  indicates that the file(s) used as part of the check were missing or unreadable.</li>
<li><code>5</code>  indicates that the parameters passed to the script were incomplete or invalid.</li>
<li><code>9</code>  indicates that the script ran, but warning messages were generated.</li>
<li><code>16</code> indicates that the check did NOT fail, but the manifest row should be marked as ignored.</li>
</ul>
<p>When creating a check script at its simplest form, a script that returns
either <code>0</code> or <code>1</code> will suffice.</p>
<p>Note the special value <code>16</code> allows a script to stop a row from being futher processed.
Essentially, this can be leveraged to do the same thing as a <code>filter:</code> would (ignoring
the manifest row), only from within the <code>stages:</code> section.</p>
<p>Exit code can be broken down into binary representation, each bit indicated
a state. Each state has a descriptive string associated with it. Numerical values
may be added up to represent the desired status.
(E.g. <code>25</code> would indicate <code>16</code> + <code>8</code> + <code>1</code>)</p>
<table>
<thead>
<tr>
<th>Number (Bit)</th>
<th>Descriptive message</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>128 (7)</td>
<td>N/A</td>
<td>Bit reserved for future use</td>
</tr>
<tr>
<td>64 (6)</td>
<td>N/A</td>
<td>Bit reserved for future use</td>
</tr>
<tr>
<td>32 (5)</td>
<td>N/A</td>
<td>Bit reserved for future use</td>
</tr>
<tr>
<td>16 (4)</td>
<td><code>skip_manfest_row</code></td>
<td>Script indicated this manifest row should be skipped in all further processing</td>
</tr>
<tr>
<td>8 (3)</td>
<td><code>warning_logged</code></td>
<td>One or more warning was generated by the script</td>
</tr>
<tr>
<td>4 (2)</td>
<td><code>bad_argument</code></td>
<td>One or more script arguments were incorrect or misused</td>
</tr>
<tr>
<td>2 (1)</td>
<td><code>inaccessible_file</code></td>
<td>One or more files were missing or inaccessible</td>
</tr>
<tr>
<td>1 (0)</td>
<td><code>failure</code></td>
<td>Script encountered failure</td>
</tr>
<tr>
<td>0 (if unset)</td>
<td><code>success</code></td>
<td>Script ran without a failure</td>
</tr>
</tbody>
</table>
<h4 id="results-json-file-as-input-argument">Results JSON File as Input Argument</h4>
<p>It is recommended that scripts accept a JSON file as an argument (using the <code>-J</code>
flag is preferred). The scripts may then output structured results by
creating/updating the JSON file.</p>
<p>If the given results JSON file already exist, the script should add data to it.
If the JSON file does not exist, then the script must create the file itself.</p>
<p>In dealing with the results JSON files, the script should:</p>
<ul>
<li>Never overwrite other data already in and existing JSON file.</li>
<li>Attempt to write data in a way where collisions would never occur; e.g. appending to a list.</li>
<li>Separate results generated using the check script from other results in the file.</li>
<li>Preferably, output should be written under a key that matches the script's filename.</li>
</ul>
<p>Writing to the results file in the following manner <strong>is recommended</strong>:
<div class="highlight"><pre><span></span><code>{
  &quot;my-check-script&quot;: [
    {
      &quot;file&quot;: &quot;/path/to/fileA.txt&quot;,
      &quot;outcome&quot;: &quot;acceptable&quot;
    },
    {
      &quot;file&quot;: &quot;/path/to/fileB.txt&quot;,
      &quot;outcome&quot;: &quot;unacceptable&quot;
    }
  ]
}
</code></pre></div>
However, writing to the results file in this next manner <strong>is discouraged</strong>:
<div class="highlight"><pre><span></span><code>{
  &quot;/path/to/fileA.txt&quot;: [
    {
      &quot;script&quot;: &quot;my-check-script&quot;,
      &quot;outcome&quot;: &quot;acceptable&quot;
    }
  ],
  &quot;/path/to/fileB.txt&quot;: [
    {
      &quot;script&quot;: &quot;my-check-script&quot;,
      &quot;outcome&quot;: &quot;unacceptable&quot;
    }
  ]
}
</code></pre></div></p>
<p>This second <strong>bad example</strong> of output fails to separate the script output from
other types of output. If two scripts did the same practice, then both
differing output types would be mixed in the same list format! This would be
very annoying to try to parse.</p>
<h2 id="author-and-copyright">Author and Copyright</h2>
<p>Written by Nathan Collins (npcollins/gmail/com)  </p>
<p>Copyright  2021 Michigan State University Board of Trustees  </p>
<h2 id="license">License</h2>
<p>Released under the MIT License</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": ".", "features": [], "search": "assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.b425cdc4.min.js"></script>
      
    
  </body>
</html>